# نظام استعادة كلمة المرور بالرمز العشوائي

## نظرة عامة

تم تطوير نظام جديد لاستعادة كلمة المرور يستخدم رموز عشوائية قصيرة (6 أحرف) بدلاً من الروابط الطويلة، مما يجعل العملية أكثر أماناً وسهولة للمستخدمين.

## التدفق الجديد

### 1. طلب استعادة كلمة المرور
- المستخدم يدخل بريده الإلكتروني في صفحة `/forgot-password`
- النظام ينشئ رمز عشوائي قصير (6 أحرف مثل: `ABC123`)
- يتم إرسال الرمز عبر البريد الإلكتروني
- توجيه المستخدم تلقائياً لصفحة إدخال الرمز

### 2. التحقق من الرمز
- المستخدم يدخل الرمز في صفحة `/verify-reset-code`
- النظام يتحقق من صحة الرمز وانتهاء صلاحيته
- إذا كان الرمز صحيح، يظهر نموذج كلمة المرور الجديدة

### 3. تعيين كلمة المرور الجديدة
- المستخدم يدخل كلمة المرور الجديدة وتأكيدها
- النظام يحدث كلمة المرور
- توجيه للدخول الإداري

## المكونات الجديدة

### API Endpoints
- `POST /api/auth/forgot-password` - إرسال رمز الاستعادة
- `POST /api/auth/verify-reset-code` - التحقق من الرمز
- `POST /api/auth/reset-password` - إعادة تعيين كلمة المرور (موجود مسبقاً)

### صفحات الواجهة
- `/forgot-password` - طلب رمز الاستعادة (محدثة)
- `/verify-reset-code` - إدخال الرمز وتعيين كلمة مرور جديدة (جديدة)

### خدمات البريد الإلكتروني
- `EmailService.sendPasswordResetEmail()` - محدثة لإرسال الرمز بدلاً من الرابط

## المميزات الجديدة

### الأمان
- رموز قصيرة (6 أحرف) أسهل في الكتابة
- انتهاء صلاحية خلال 15 دقيقة
- تحقق اختياري من البريد الإلكتروني
- عدم إفشاء معلومات حساسة

### تجربة المستخدم
- واجهة عربية سهلة الاستخدام
- مؤشر قوة كلمة المرور
- تأكيد تطابق كلمة المرور
- رسائل خطأ واضحة
- تصميم متجاوب

### التوافق
- يعمل مع قاعدة البيانات الحقيقية (MongoDB)
- يعمل مع النظام الوهمي للاختبار (MockAuthService)
- متوافق مع النظام القديم للروابط

## كيفية الاختبار

### اختبار البريد الإلكتروني
```bash
npx ts-node scripts/test-email-code.ts
```

### اختبار النظام كاملاً
1. اذهب إلى `/admin/forgot-password`
2. أدخل بريد إلكتروني صحيح
3. ستتم إعادة توجيهك لصفحة إدخال الرمز
4. أدخل الرمز المرسل في البريد
5. عيّن كلمة مرور جديدة
6. سجل الدخول بكلمة المرور الجديدة

## الإعدادات المطلوبة

تأكد من وجود متغيرات البيئة التالية في `.env`:

```env
EMAIL_USER=your-email@gmail.com
EMAIL_APP_PASSWORD=your-app-password
NEXTAUTH_URL=http://localhost:3000
```

## ملاحظات التطوير

- النظام القديم (بالروابط) ما زال يعمل للتوافق
- يمكن التبديل بين النظامين حسب الحاجة
- جميع النصوص باللغة العربية
- التصميم يتبع نمط إسلامي بسيط بدون تدرجات أو رسوم متحركة

## استكشاف الأخطاء

### مشكلة إرسال البريد الإلكتروني
- تحقق من إعدادات SMTP في `lib/email.ts`
- تأكد من صحة `EMAIL_USER` و `EMAIL_APP_PASSWORD`
- تفعيل "تطبيقات أقل أماناً" في Gmail

### مشكلة التحقق من الرمز
- تحقق من صحة الرمز (حساس للأحرف الكبيرة/الصغيرة)
- تأكد من عدم انتهاء صلاحية الرمز (15 دقيقة)
- تحقق من اتصال قاعدة البيانات

### مشكلة إعادة التوجيه
- تأكد من صحة `NEXTAUTH_URL` في متغيرات البيئة
- تحقق من routing في Next.js
