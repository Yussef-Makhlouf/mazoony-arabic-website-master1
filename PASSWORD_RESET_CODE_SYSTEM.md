# نظام رموز إعادة تعيين كلمة المرور

## 🎯 نظرة عامة

نظام آمن لإعادة تعيين كلمات المرور يعمل **100% مع قاعدة البيانات الحقيقية** بدون أي بيانات وهمية.

## 🔐 الميزات

### 1. الأمان
- رموز استعادة من 6 أحرف
- صلاحية محدودة (15 دقيقة)
- تشفير كلمات المرور
- حماية من هجمات Brute Force

### 2. قاعدة البيانات
- **يعمل فقط مع MongoDB الحقيقية**
- **لا يوجد نظام وهمي**
- جميع البيانات تُحفظ في قاعدة البيانات
- تتبع كامل لعمليات إعادة التعيين

### 3. البريد الإلكتروني
- إرسال آلي لرموز الاستعادة
- تصميم عربي احترافي
- تحذيرات أمنية واضحة
- روابط احتياطية

## 🏗️ الهيكل التقني

### API Endpoints
```
POST /api/auth/forgot-password     - طلب إعادة تعيين
POST /api/auth/verify-reset-code   - التحقق من الرمز
POST /api/auth/reset-password      - تغيير كلمة المرور
```

### قاعدة البيانات
```javascript
// مجموعة resetTokens
{
  _id: ObjectId,
  userId: ObjectId,
  email: String,
  token: String,
  expiresAt: Date,
  createdAt: Date
}

// مجموعة users
{
  _id: ObjectId,
  email: String,
  password: String, // مشفرة
  name: String,
  role: String,
  isActive: Boolean
}
```

## 🔄 تدفق العملية

### 1. طلب إعادة التعيين
```
المستخدم → /forgot-password → إدخال البريد → إنشاء رمز → إرسال بريد
```

### 2. التحقق من الرمز
```
المستخدم → /verify-reset-code → إدخال الرمز → التحقق → إنشاء token
```

### 3. تغيير كلمة المرور
```
المستخدم → /reset-password → إدخال كلمة جديدة → تحديث قاعدة البيانات
```

## 🛡️ إجراءات الأمان

### 1. حماية البيانات
- تشفير كلمات المرور بـ bcrypt
- رموز عشوائية قوية
- صلاحية زمنية محدودة

### 2. منع الهجمات
- حماية من Email Enumeration
- حماية من Brute Force
- تتبع محاولات الفشل

### 3. الخصوصية
- إخفاء البريد الإلكتروني في الاستجابات
- عدم كشف معلومات المستخدمين
- رسائل خطأ عامة

## 📧 نظام البريد الإلكتروني

### الإعدادات المطلوبة
```bash
EMAIL_USER=yussef.ali.it@gmail.com
EMAIL_APP_PASSWORD=hxigwtmkxdxtvqdy
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
```

### محتوى البريد
- رمز الاستعادة (6 أحرف)
- رابط إعادة التعيين
- تحذيرات أمنية
- معلومات الموقع

## 🚀 التطوير والإنتاج

### التطوير
- يتطلب MongoDB محلية أو Atlas
- يتطلب إعدادات SMTP صحيحة
- لا يوجد fallback للنظام الوهمي

### الإنتاج
- نفس المتطلبات
- إعدادات أمان إضافية
- مراقبة الأخطاء
- نسخ احتياطية

## ✅ الاختبار

### متطلبات الاختبار
1. **MongoDB متاحة** ومتصل
2. **إعدادات SMTP** صحيحة
3. **مستخدمين موجودين** في قاعدة البيانات

### خطوات الاختبار
1. إنشاء مستخدم في قاعدة البيانات
2. طلب إعادة تعيين كلمة المرور
3. التحقق من وصول البريد
4. استخدام الرمز لتغيير كلمة المرور

## ⚠️ ملاحظات مهمة

1. **النظام يتوقف** إذا فشل الاتصال بقاعدة البيانات
2. **لا يمكن اختباره** بدون قاعدة بيانات
3. **جميع المستخدمين** يجب إنشاؤهم في قاعدة البيانات
4. **النظام آمن 100%** ويعمل مع البيانات الحقيقية فقط

## 🔧 استكشاف الأخطاء

### مشاكل قاعدة البيانات
- تحقق من `MONGODB_URI`
- تأكد من تشغيل MongoDB
- راجع Console للأخطاء

### مشاكل البريد الإلكتروني
- تحقق من إعدادات SMTP
- تأكد من كلمة مرور التطبيق
- راجع مجلد البريد المزعج

### مشاكل المستخدمين
- تأكد من وجود المستخدم في قاعدة البيانات
- تحقق من صحة البريد الإلكتروني
- راجع حالة المستخدم (isActive)
