import { getDatabase } from '../lib/mongodb';
import { AuthService } from '../lib/auth';

async function initializeAuth() {
  try {
    console.log('ğŸ”„ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©...');
    
    const db = await getDatabase();
    
    // Create collections if they don't exist
    const collections = [
      'users',
      'passwordResetTokens',
      'loginAttempts'
    ];
    
    for (const collection of collections) {
      try {
        await db.createCollection(collection);
        console.log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© ${collection}`);
      } catch (error: any) {
        if (error.code === 48) {
          console.log(`â„¹ï¸  Ù…Ø¬Ù…ÙˆØ¹Ø© ${collection} Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„`);
        } else {
          throw error;
        }
      }
    }
    
    // Create indexes for users collection
    await db.collection('users').createIndex({ email: 1 }, { unique: true });
    console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙÙ‡Ø±Ø³ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†');
    
    await db.collection('users').createIndex({ role: 1 });
    await db.collection('users').createIndex({ isActive: 1 });
    await db.collection('users').createIndex({ createdAt: -1 });
    await db.collection('users').createIndex({ lastLogin: -1 });
    console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙÙ‡Ø§Ø±Ø³ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†');
    
    // Create indexes for password reset tokens
    await db.collection('passwordResetTokens').createIndex({ token: 1 }, { unique: true });
    await db.collection('passwordResetTokens').createIndex({ userId: 1 });
    await db.collection('passwordResetTokens').createIndex({ expiresAt: 1 }, { expireAfterSeconds: 0 });
    console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙÙ‡Ø§Ø±Ø³ Ø±Ù…ÙˆØ² Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
    
    // Create indexes for login attempts
    await db.collection('loginAttempts').createIndex({ email: 1 });
    await db.collection('loginAttempts').createIndex({ ipAddress: 1 });
    await db.collection('loginAttempts').createIndex({ createdAt: -1 });
    // Auto-delete login attempts after 30 days
    await db.collection('loginAttempts').createIndex({ createdAt: 1 }, { expireAfterSeconds: 30 * 24 * 60 * 60 });
    console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙÙ‡Ø§Ø±Ø³ Ù…Ø­Ø§ÙˆÙ„Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
    
    // Create default admin user
    await AuthService.createDefaultAdmin();
    console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©');
    
    console.log('ğŸ‰ ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­!');
    console.log('');
    console.log('ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ù…Ø¯ÙŠØ±: admin@mazoony.com');
    console.log('ğŸ” ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: admin123');
    console.log('');
    console.log('âš ï¸  ÙŠØ±Ø¬Ù‰ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
    
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:', error);
    process.exit(1);
  } finally {
    process.exit(0);
  }
}

// Run initialization
initializeAuth();
